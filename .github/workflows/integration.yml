name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  workflow_call:
    secrets:
      OPENAI_API_KEY:
        required: true
      ANTHROPIC_API_KEY:
        required: false
      GOOGLE_API_KEY:
        required: false
      XAI_API_KEY:
        required: false
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false
      MEMORI_API_KEY:
        required: false

permissions:
  contents: read

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: memori
          POSTGRES_PASSWORD: memori
          POSTGRES_DB: memori_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: memori
          MYSQL_DATABASE: memori_test
          MYSQL_USER: memori
          MYSQL_PASSWORD: memori
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mongodb:
        image: mongo:6
        env:
          MONGO_INITDB_ROOT_USERNAME: memori
          MONGO_INITDB_ROOT_PASSWORD: memori
        ports:
          - 27017:27017

    env:
      MEMORI_TEST_MODE: "1"
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1
      MEMORI_API_KEY: ${{ secrets.MEMORI_API_KEY }}
      SQLITE_DATABASE_URL: sqlite:///test_memori.db
      POSTGRES_DATABASE_URL: postgresql://memori:memori@localhost:5432/memori_test
      MYSQL_DATABASE_URL: mysql+pymysql://memori:memori@localhost:3306/memori_test
      MONGODB_URL: mongodb://memori:memori@localhost:27017/memori_test?authSource=admin

    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --dev

      - name: Run AA Payload Unit Tests (no API keys needed)
        run: |
          echo "Running AA payload unit tests..."
          uv run pytest tests/memory/augmentation/test_aa_payload_unit.py -v --tb=short

      - name: Run AA Integration Tests (staging API)
        if: env.OPENAI_API_KEY
        run: |
          echo "Running AA integration tests against staging..."
          uv run pytest tests/integration/test_aa_payload.py -v -m integration --tb=short

      - name: Run OpenAI Integration Tests
        if: env.OPENAI_API_KEY
        run: |
          echo "Running OpenAI integration tests..."
          uv run pytest tests/integration/providers/test_openai.py -v -m integration --tb=short

      - name: Run Anthropic Integration Tests
        if: env.ANTHROPIC_API_KEY
        run: |
          echo "Running Anthropic integration tests..."
          uv run pytest tests/integration/providers/test_anthropic.py -v -m integration --tb=short

      - name: Run Google Integration Tests
        if: env.GOOGLE_API_KEY
        run: |
          echo "Running Google integration tests..."
          uv run pytest tests/integration/providers/test_google.py -v -m integration --tb=short

      - name: Run xAI Integration Tests
        if: env.XAI_API_KEY
        run: |
          echo "Running xAI integration tests..."
          uv run pytest tests/integration/providers/test_xai.py -v -m integration --tb=short

      - name: Run Bedrock Integration Tests
        if: env.AWS_ACCESS_KEY_ID && env.AWS_SECRET_ACCESS_KEY
        run: |
          echo "Running Bedrock integration tests..."
          uv run pytest tests/integration/providers/test_bedrock.py -v -m integration --tb=short

      - name: Run Hosted OpenAI Integration Tests
        if: env.OPENAI_API_KEY && env.MEMORI_API_KEY
        run: |
          echo "Running hosted OpenAI integration tests..."
          uv run pytest tests/integration/hosted/test_hosted_openai.py -v -m integration --tb=short

      - name: Run Hosted Anthropic Integration Tests
        if: env.ANTHROPIC_API_KEY && env.MEMORI_API_KEY
        run: |
          echo "Running hosted Anthropic integration tests..."
          uv run pytest tests/integration/hosted/test_hosted_anthropic.py -v -m integration --tb=short

      - name: Run Hosted Google Integration Tests
        if: env.GOOGLE_API_KEY && env.MEMORI_API_KEY
        run: |
          echo "Running hosted Google integration tests..."
          uv run pytest tests/integration/hosted/test_hosted_gemini.py -v -m integration --tb=short

      - name: Run Hosted xAI Integration Tests
        if: env.XAI_API_KEY && env.MEMORI_API_KEY
        run: |
          echo "Running hosted xAI integration tests..."
          uv run pytest tests/integration/hosted/test_hosted_xai.py -v -m integration --tb=short

      - name: Run Hosted Bedrock Integration Tests
        if: env.AWS_ACCESS_KEY_ID && env.AWS_SECRET_ACCESS_KEY && env.MEMORI_API_KEY
        run: |
          echo "Running hosted Bedrock integration tests..."
          uv run pytest tests/integration/hosted/test_hosted_bedrock.py -v -m integration --tb=short

      - name: Run Database Integration Tests
        if: env.OPENAI_API_KEY
        run: |
          echo "Running database integration tests..."
          uv run pytest tests/integration/databases/ -v -m integration --tb=short

      - name: Integration Test Summary
        if: always()
        run: |
          echo "=========================================="
          echo "Integration Test Summary"
          echo "=========================================="
          echo "MEMORI_TEST_MODE: $MEMORI_TEST_MODE (staging)"
          echo ""
          echo "Tests run:"
          echo "  - AA Payload Unit Tests: Yes (no API keys needed)"
          if [ "$OPENAI_API_KEY" ]; then echo "  - AA Integration Tests: Yes"; else echo "  - AA Integration Tests: Skipped (no key)"; fi
          if [ "$OPENAI_API_KEY" ]; then echo "  - Database Integration Tests: Yes"; else echo "  - Database Integration Tests: Skipped (no key)"; fi
          echo ""
          echo "Databases tested:"
          echo "  - SQLite: Yes"
          echo "  - PostgreSQL: Yes"
          echo "  - MySQL: Yes"
          echo "  - MongoDB: Yes"
          echo ""
          echo "Providers tested:"
          if [ "$OPENAI_API_KEY" ]; then echo "  - OpenAI: Yes"; else echo "  - OpenAI: Skipped (no key)"; fi
          if [ "$ANTHROPIC_API_KEY" ]; then echo "  - Anthropic: Yes"; else echo "  - Anthropic: Skipped (no key)"; fi
          if [ "$GOOGLE_API_KEY" ]; then echo "  - Google: Yes"; else echo "  - Google: Skipped (no key)"; fi
          if [ "$XAI_API_KEY" ]; then echo "  - xAI: Yes"; else echo "  - xAI: Skipped (no key)"; fi
          if [ "$AWS_ACCESS_KEY_ID" ]; then echo "  - Bedrock: Yes"; else echo "  - Bedrock: Skipped (no key)"; fi
          echo ""
          echo "Hosted (requires MEMORI_API_KEY) tests:"
          if [ "$MEMORI_API_KEY" ] && [ "$OPENAI_API_KEY" ]; then echo "  - Hosted OpenAI: Yes"; else echo "  - Hosted OpenAI: Skipped (no key)"; fi
          if [ "$MEMORI_API_KEY" ] && [ "$ANTHROPIC_API_KEY" ]; then echo "  - Hosted Anthropic: Yes"; else echo "  - Hosted Anthropic: Skipped (no key)"; fi
          if [ "$MEMORI_API_KEY" ] && [ "$GOOGLE_API_KEY" ]; then echo "  - Hosted Google: Yes"; else echo "  - Hosted Google: Skipped (no key)"; fi
          if [ "$MEMORI_API_KEY" ] && [ "$XAI_API_KEY" ]; then echo "  - Hosted xAI: Yes"; else echo "  - Hosted xAI: Skipped (no key)"; fi
          if [ "$MEMORI_API_KEY" ] && [ "$AWS_ACCESS_KEY_ID" ]; then echo "  - Hosted Bedrock: Yes"; else echo "  - Hosted Bedrock: Skipped (no key)"; fi
          echo "=========================================="
